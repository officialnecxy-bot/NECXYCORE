<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NECXYCORE</title>
    
    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        primary: '#FF003C', 
                        glass: '#0a0a0a',
                        dark: '#000000',
                        card: '#0c0c0c',
                        accent: '#22C55E',
                        social: '#833ab4',
                        ott: '#ff5e62',
                        vpn: '#2193b0',
                        notes: '#654ea3',
                        used: '#FFA500',
                        fb: '#1877F2'
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    animation: { 
                        'fade-in': 'fadeIn 0.3s ease-out', 
                        'pop-up': 'popUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)', 
                        'slide-down': 'slideDown 0.3s ease-out', 
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        popUp: { '0%': { transform: 'scale(0.95) translateY(20px)', opacity: '0' }, '100%': { transform: 'scale(1) translateY(0)', opacity: '1' } },
                        slideDown: { '0%': { transform: 'translateY(-20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' } },
                        glow: { '0%': { boxShadow: '0 0 10px rgba(255,0,60,0.3)' }, '100%': { boxShadow: '0 0 20px rgba(255,0,60,0.6)' } },
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { 
            background-color: #000000; 
            color: white; 
            font-family: 'Outfit', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Animated background orbs (copied from first web) */
        .bg-orbs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        .bg-orbs span {
            position: absolute;
            width: 30vmax;
            height: 30vmax;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 26, 76, 0.2), transparent 70%);
            animation: float 20s infinite ease-in-out;
        }
        .bg-orbs span:nth-child(1) { top: 10%; left: 10%; animation-duration: 25s; }
        .bg-orbs span:nth-child(2) { bottom: 15%; right: 10%; width: 40vmax; height: 40vmax; background: radial-gradient(circle at 70% 70%, rgba(200, 0, 50, 0.15), transparent 80%); animation-duration: 30s; }
        .bg-orbs span:nth-child(3) { top: 40%; left: 60%; width: 25vmax; height: 25vmax; background: radial-gradient(circle at 40% 40%, rgba(255, 80, 120, 0.15), transparent 70%); animation-duration: 22s; }
        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(2%, 3%) scale(1.05); }
            66% { transform: translate(-2%, 1%) scale(0.95); }
            100% { transform: translate(0, 0) scale(1); }
        }

        #auth-screen { 
            position: fixed; 
            inset: 0; 
            z-index: 999; 
            background: transparent; /* let orbs show through */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        .app-layout { 
            padding-top: 0;  /* changed from 140px to 0 */
            padding-bottom: 30px; 
            position: relative; 
            z-index: 1; 
            display: none; 
        }
        
        .glass-panel { 
            background: rgba(12, 12, 12, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .header-capsule {
            background: rgba(5, 5, 5, 0.8);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-radius: 60px;
            padding: 10px 20px;
            margin: 12px 16px;
            width: calc(100% - 32px);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 8px 16px;
            margin-top: 80px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 45;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .filter-btn {
            padding: 8px 20px;
            border-radius: 40px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
            background: rgba(20,20,20,0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: #aaa;
            transition: all 0.2s;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #FF003C 0%, #CC002F 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(255,0,60,0.4);
        }
        
        .search-bar {
            position: fixed;
            top: 130px;
            left: 16px;
            right: 16px;
            z-index: 44;
            background: rgba(10,10,10,0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .search-bar i { color: #666; }
        .search-bar input {
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
        }
        .search-bar input::placeholder { color: #444; }
        
        .note-card { 
            background: linear-gradient(145deg, #0c0c0c 0%, #080808 100%);
            border: 1px solid rgba(255, 255, 255, 0.05); 
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); 
            position: relative; 
            overflow: hidden; 
            transition: all 0.3s ease;
        }
        .note-card:hover { 
            transform: translateY(-4px); 
            border-color: rgba(255, 0, 60, 0.3); 
            box-shadow: 0 15px 40px rgba(255, 0, 60, 0.2);
        }
        .note-card:active { transform: translateY(0) scale(0.98); border-color: #FF003C; }
        
        .big-modal { 
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9), 0 0 50px rgba(255, 0, 60, 0.2); 
            width: 100%; 
            max-width: 420px; 
            border-radius: 32px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            max-height: 85vh; 
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FF003C 0%, #CC002F 100%);
            color: white;
            border: none;
            box-shadow: 0 5px 20px rgba(255, 0, 60, 0.4), 0 0 15px rgba(255, 0, 60, 0.2);
            border-radius: 16px;
            font-weight: 800;
            letter-spacing: 0.5px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .used-badge {
            background: rgba(255,165,0,0.15);
            border: 1px solid rgba(255,165,0,0.3);
            color: #FFA500;
        }
        .fb-badge {
            background: rgba(24,119,242,0.15);
            border: 1px solid rgba(24,119,242,0.3);
            color: #1877F2;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #FF003C 0%, #22C55E 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* FAB removed from bottom, now in header */

        .copy-btn, .eye-btn, .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            transition: color 0.2s;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
        }
        .copy-btn:hover, .eye-btn:hover { color: #FF003C; background: rgba(255,0,60,0.1); }
        .delete-history-btn:hover { color: #ff4444; background: rgba(255,0,0,0.1); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .field-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20,20,20,0.5);
            padding: 12px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 10px;
        }
        .field-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: #888;
            width: 70px;
        }
        .field-value {
            font-family: monospace;
            font-size: 13px;
            font-weight: 500;
            color: white;
            word-break: break-word;
            flex: 1;
            padding: 0 8px;
        }
        .password-value {
            font-family: monospace;
            font-size: 13px;
            font-weight: 500;
            color: white;
            flex: 1;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin-left: 8px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .3s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #FF003C; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .tab-active { 
            background: linear-gradient(135deg, #FF003C 0%, #CC002F 100%); 
            color: white; 
            border: none; 
            box-shadow: 0 4px 15px rgba(255,0,60,0.4); 
        }
        .tab-inactive { 
            background: rgba(21, 21, 21, 0.8); 
            color: #888; 
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .custom-dropdown {
            position: relative;
            width: 100%;
        }
        .dropdown-selected {
            background: rgba(20,20,20,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        .dropdown-selected:hover { border-color: rgba(255,0,60,0.5); }
        .dropdown-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0; right: 0;
            background: rgba(15,15,15,0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            overflow: hidden;
            z-index: 60;
            display: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .dropdown-options.show { display: block; animation: fadeIn 0.2s ease; }
        .dropdown-option {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-weight: 600;
            font-size: 14px;
        }
        .dropdown-option:hover { background: rgba(255,0,60,0.15); }
        .dropdown-option i { font-size: 16px; width: 24px; }
        .cat-social { color: #833ab4; }
        .cat-ott { color: #ff5e62; }
        .cat-vpn { color: #2193b0; }
        .cat-notes { color: #654ea3; }
    </style>
</head>
<body>
    <!-- Animated background orbs (exactly from first web) -->
    <div class="bg-orbs">
        <span></span><span></span><span></span>
    </div>

    <!-- Toast Area -->
    <div id="toast-area" class="fixed top-24 left-0 right-0 z-[200] flex flex-col items-center gap-3 pointer-events-none px-4"></div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10 animate-fade-in">
                <div class="relative mb-6">
                    <div class="absolute inset-0 bg-primary/20 blur-[50px] rounded-full animate-pulse-slow"></div>
                    <h1 class="text-5xl font-black tracking-tighter leading-none mb-2 relative z-10">
                        <span class="text-primary drop-shadow-[0_0_15px_rgba(255,0,60,0.6)]">NECX</span>
                        <span class="text-white">CORE</span>
                    </h1>
                </div>
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-[4px] animate-slide-down">secure vault access</p>
            </div>
            <div class="glass-panel p-8 rounded-[35px] shadow-2xl relative overflow-hidden animate-pop-up">
                <div class="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-[50px] animate-float"></div>
                <div class="flex bg-black/50 p-1 rounded-xl mb-6 border border-white/5">
                    <button onclick="toggleAuth('login')" id="tab-login" class="tab-btn flex-1 py-3 rounded-lg text-xs font-black uppercase transition-all tab-active">Login</button>
                    <button onclick="toggleAuth('signup')" id="tab-signup" class="tab-btn flex-1 py-3 rounded-lg text-xs font-black uppercase transition-all tab-inactive">Sign Up</button>
                </div>
                <div id="form-container">
                    <div id="input-name-group" class="mb-4 hidden animate-fade-in">
                        <label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">Name</label>
                        <div class="bg-black/30 border border-white/10 rounded-xl px-4 py-3 flex items-center gap-3 focus-within:border-primary">
                            <i class="fa-regular fa-user text-gray-500 text-sm"></i>
                            <input type="text" id="auth-name" placeholder="Your name" class="bg-transparent w-full text-sm font-bold text-white outline-none">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">Email</label>
                        <div class="bg-black/30 border border-white/10 rounded-xl px-4 py-3 flex items-center gap-3 focus-within:border-primary">
                            <i class="fa-regular fa-envelope text-gray-500 text-sm"></i>
                            <input type="email" id="auth-email" placeholder="email@example.com" class="bg-transparent w-full text-sm font-bold text-white outline-none">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">Password</label>
                        <div class="bg-black/30 border border-white/10 rounded-xl px-4 py-3 flex items-center gap-3 focus-within:border-primary">
                            <i class="fa-regular fa-lock text-gray-500 text-sm"></i>
                            <input type="password" id="auth-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="bg-transparent w-full text-sm font-bold text-white outline-none">
                        </div>
                    </div>
                    <div id="confirm-pass-group" class="mb-8 hidden">
                        <label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">Confirm Password</label>
                        <div class="bg-black/30 border border-white/10 rounded-xl px-4 py-3 flex items-center gap-3 focus-within:border-primary">
                            <i class="fa-regular fa-lock text-gray-500 text-sm"></i>
                            <input type="password" id="auth-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="bg-transparent w-full text-sm font-bold text-white outline-none">
                        </div>
                    </div>
                    <button id="btn-auth-action" onclick="handleAuth()" class="w-full btn-primary text-white py-4 rounded-xl font-black uppercase text-xs tracking-[3px] active:scale-95 transition-all">
                        <span id="auth-btn-text">Enter vault</span>
                        <span id="auth-loader" class="loader hidden ml-2"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="app-layout">
        <div class="header-capsule">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-black tracking-tighter">
                    <span class="text-primary">NECX</span><span class="text-white">CORE</span>
                </h1>
                <span id="note-count" class="text-[10px] font-bold bg-primary/20 px-3 py-1 rounded-full border border-primary/30">0</span>
            </div>
            <div class="flex items-center gap-2">
                <!-- New add button in header -->
                <button onclick="openAddModal()" class="w-10 h-10 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-white/10 hover:scale-105 transition">
                    <i class="fa-solid fa-plus text-primary"></i>
                </button>
                <button onclick="openProfileModal()" class="w-10 h-10 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-white/10 hover:scale-105 transition">
                    <i class="fa-regular fa-user text-primary"></i>
                </button>
            </div>
        </div>

        <div class="filter-bar no-scrollbar">
            <button class="filter-btn active" data-filter="all" onclick="filterNotes('all', this)">All</button>
            <button class="filter-btn" data-filter="social" onclick="filterNotes('social', this)">Social</button>
            <button class="filter-btn" data-filter="ott" onclick="filterNotes('ott', this)">OTT</button>
            <button class="filter-btn" data-filter="vpn" onclick="filterNotes('vpn', this)">VPN</button>
            <button class="filter-btn" data-filter="notes" onclick="filterNotes('notes', this)">Notes</button>
        </div>

        <div class="search-bar">
            <i class="fa-solid fa-search"></i>
            <input type="text" id="search-input" placeholder="Search by title, tag, content..." oninput="performSearch()">
            <button onclick="clearSearch()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
        </div>

        <!-- Added mt-[180px] to start grid right below search bar, removed pt-28 -->
        <section id="page-home" class="px-4 mt-[180px] animate-fade-in block">
            <div id="notes-grid" class="grid grid-cols-1 gap-4 pb-24">
                <div class="text-center py-20 opacity-60">
                    <i class="fa-regular fa-pen-to-square text-5xl text-white/20 mb-3"></i>
                    <p class="text-gray-500 text-sm font-bold uppercase tracking-widest">no entries yet</p>
                    <p class="text-gray-600 text-[10px] mt-1">tap the + to add one</p>
                </div>
            </div>
        </section>

        <!-- FAB removed from bottom -->
    </div>

    <!-- ADD / EDIT NOTE MODAL -->
    <div id="modal-add-note" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-xl" onclick="closeAddModal()"></div>
        <div class="big-modal relative z-10 animate-pop-up p-6">
            <button onclick="closeAddModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-black/70"><i class="fa-solid fa-xmark"></i></button>
            <h2 id="modal-add-title" class="text-2xl font-black uppercase text-white mb-4 text-center gradient-text">new record</h2>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-1 no-scrollbar">
                <div>
                    <label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">type</label>
                    <div class="custom-dropdown" id="category-dropdown">
                        <div class="dropdown-selected" onclick="toggleDropdown()">
                            <span id="selected-category-display">
                                <!-- Default to social now -->
                                <i class="fa-brands fa-instagram cat-social"></i>
                                <span>Social</span>
                            </span>
                            <i class="fa-solid fa-chevron-down text-gray-400"></i>
                        </div>
                        <div class="dropdown-options" id="dropdown-options">
                            <div class="dropdown-option" data-value="social" onclick="selectCategory('social')">
                                <i class="fa-brands fa-instagram cat-social"></i> <span>Social</span>
                            </div>
                            <div class="dropdown-option" data-value="ott" onclick="selectCategory('ott')">
                                <i class="fa-solid fa-film cat-ott"></i> <span>OTT</span>
                            </div>
                            <div class="dropdown-option" data-value="vpn" onclick="selectCategory('vpn')">
                                <i class="fa-solid fa-shield-halved cat-vpn"></i> <span>VPN</span>
                            </div>
                            <div class="dropdown-option" data-value="notes" onclick="selectCategory('notes')">
                                <i class="fa-solid fa-note-sticky cat-notes"></i> <span>Notes</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="note-category" value="social"> <!-- default social -->
                </div>

                <div>
                    <label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">title</label>
                    <input type="text" id="note-title" placeholder="e.g. Netflix, Gmail" class="w-full glass-panel border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-white outline-none bg-transparent">
                </div>
                <div>
                    <label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">tag (optional)</label>
                    <input type="text" id="note-tag" placeholder="work, personal, etc." class="w-full glass-panel border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-white outline-none bg-transparent">
                </div>
                <div class="flex items-center justify-between glass-panel p-3 rounded-xl border border-white/10">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Mark as used</span>
                    <label class="switch">
                        <input type="checkbox" id="note-used">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- New FB Fixed toggle (initially hidden, shown only for social) -->
                <div id="fb-toggle-container" class="flex items-center justify-between glass-panel p-3 rounded-xl border border-white/10">
                    <span class="text-[10px] font-bold text-gray-400 uppercase"><i class="fa-brands fa-facebook-f mr-1 text-[#1877F2]"></i> FB Fixed</span>
                    <label class="switch">
                        <input type="checkbox" id="note-fbfixed">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="simple-content-group">
                    <label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">content</label>
                    <textarea id="note-content" rows="4" placeholder="any text, notes..." class="w-full glass-panel border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-white outline-none bg-transparent resize-none"></textarea>
                </div>
                <div id="structured-fields-group" class="space-y-3 hidden">
                    <div><label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">email</label><input type="email" id="field-email" placeholder="email@example.com" class="w-full glass-panel border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-white outline-none bg-transparent"></div>
                    <div><label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">username</label><input type="text" id="field-username" placeholder="username" class="w-full glass-panel border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-white outline-none bg-transparent"></div>
                    <div><label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">password</label><input type="text" id="field-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full glass-panel border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-white outline-none bg-transparent"></div>
                    <div><label class="text-[9px] font-bold text-gray-500 uppercase ml-2 mb-1 block">note (optional)</label><textarea id="field-note" rows="2" placeholder="extra info..." class="w-full glass-panel border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-white outline-none bg-transparent resize-none"></textarea></div>
                </div>
            </div>
            <button id="save-note-btn" onclick="saveNote()" class="w-full btn-primary text-white py-4 rounded-xl font-black uppercase text-xs tracking-widest mt-4">
                <span id="save-btn-text"><i class="fa-regular fa-floppy-disk mr-2"></i> save entry</span>
                <span id="save-loader" class="loader hidden ml-2"></span>
            </button>
        </div>
    </div>

    <!-- VIEW NOTE MODAL -->
    <div id="modal-view-note" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-xl" onclick="closeViewModal()"></div>
        <div class="big-modal relative z-10 animate-pop-up">
            <button onclick="closeViewModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-black/70"><i class="fa-solid fa-xmark"></i></button>
            <div class="p-6 max-h-[70vh] overflow-y-auto no-scrollbar">
                <div class="flex flex-wrap gap-2 items-start mb-3">
                    <span id="view-category-badge" class="category-badge text-[10px]">category</span>
                    <span id="view-used-badge" class="category-badge used-badge hidden">used</span>
                    <span id="view-fb-badge" class="category-badge fb-badge hidden">FB</span>
                    <span id="view-tag-badge" class="category-badge bg-white/5 border-white/10 hidden"></span>
                    <span id="view-date" class="text-[9px] text-gray-500 font-mono ml-auto">just now</span>
                </div>
                <h2 id="view-title" class="text-2xl font-black uppercase text-white leading-none mb-5 gradient-text">Title</h2>
                <div id="view-fields-container" class="space-y-3 mb-8"></div>
                <div class="flex gap-3 mt-4">
                    <button onclick="editCurrentNote()" class="flex-1 py-4 rounded-xl bg-gradient-to-br from-blue-500/20 to-blue-500/10 text-blue-500 font-black uppercase text-xs border border-blue-500/30 hover:scale-[1.02] active:scale-95 transition"><i class="fa-regular fa-pen-to-square mr-2"></i> edit</button>
                    <button onclick="confirmDeleteNote()" class="flex-1 py-4 rounded-xl bg-gradient-to-br from-red-500/20 to-red-500/10 text-red-500 font-black uppercase text-xs border border-red-500/30 hover:scale-[1.02] active:scale-95 transition"><i class="fa-regular fa-trash-can mr-2"></i> delete</button>
                </div>
                <div class="mt-3">
                    <button onclick="closeViewModal()" class="w-full py-4 rounded-xl glass-panel text-white font-black uppercase text-xs border border-white/5 hover:scale-[1.02] active:scale-95 transition"><i class="fa-solid fa-arrow-left mr-2"></i> back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="modal-profile" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-xl" onclick="closeProfileModal()"></div>
        <div class="glass-panel w-full max-w-sm rounded-[35px] p-6 relative z-10 animate-pop-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black uppercase text-white gradient-text">Profile</h3>
                <button onclick="closeProfileModal()" class="w-8 h-8 rounded-full bg-black/50 flex items-center justify-center hover:bg-black/70"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <div class="glass-panel p-4 rounded-2xl border border-white/5">
                    <p class="text-[9px] text-gray-500 uppercase font-bold mb-1">Name</p>
                    <p id="profile-name" class="text-sm font-bold text-white">-</p>
                </div>
                <div class="glass-panel p-4 rounded-2xl border border-white/5">
                    <p class="text-[9px] text-gray-500 uppercase font-bold mb-1">Email</p>
                    <p id="profile-email" class="text-sm font-bold text-white">-</p>
                </div>
                <div class="glass-panel p-4 rounded-2xl border border-white/5">
                    <p class="text-[9px] text-gray-500 uppercase font-bold mb-1">Total entries</p>
                    <p id="profile-total" class="text-sm font-bold text-white">0</p>
                </div>
                <div class="glass-panel p-4 rounded-2xl border border-white/5">
                    <p class="text-[9px] text-gray-500 uppercase font-bold mb-1">Member since</p>
                    <p id="profile-joined" class="text-sm font-bold text-white">-</p>
                </div>
                <button onclick="openHistoryModal()" class="w-full py-4 rounded-xl glass-panel text-primary font-black uppercase text-xs border border-primary/30 hover:scale-[1.02] transition">
                    <i class="fa-regular fa-clock mr-2"></i> Deleted History
                </button>
                <button onclick="confirmLogout()" class="w-full py-4 rounded-xl bg-gradient-to-br from-red-500/20 to-red-500/10 text-red-500 font-black uppercase text-xs border border-red-500/30 hover:scale-[1.02] transition"><i class="fa-solid fa-power-off mr-2"></i> Log out</button>
            </div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="modal-history" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-xl" onclick="closeHistoryModal()"></div>
        <div class="big-modal relative z-10 animate-pop-up">
            <button onclick="closeHistoryModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-black/70"><i class="fa-solid fa-xmark"></i></button>
            <div class="p-6">
                <h2 class="text-2xl font-black uppercase text-white mb-4 text-center gradient-text">deleted entries</h2>
                <div id="history-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-1 no-scrollbar"></div>
                <div class="mt-6">
                    <button onclick="closeHistoryModal()" class="w-full py-4 rounded-xl glass-panel text-white font-black uppercase text-xs border border-white/5 hover:scale-[1.02] transition">close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- READ-ONLY HISTORY VIEW MODAL -->
    <div id="modal-history-view" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-xl" onclick="closeHistoryViewModal()"></div>
        <div class="big-modal relative z-10 animate-pop-up">
            <button onclick="closeHistoryViewModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-black/70"><i class="fa-solid fa-xmark"></i></button>
            <div class="p-6 max-h-[70vh] overflow-y-auto no-scrollbar">
                <div class="flex flex-wrap gap-2 items-start mb-3">
                    <span id="history-view-category" class="category-badge text-[10px]"></span>
                    <span id="history-view-used" class="category-badge used-badge hidden">used</span>
                    <span id="history-view-fb" class="category-badge fb-badge hidden">FB</span>
                    <span id="history-view-tag" class="category-badge bg-white/5 border-white/10 hidden"></span>
                    <span id="history-view-deleted" class="text-[9px] text-gray-500 font-mono ml-auto"></span>
                </div>
                <h2 id="history-view-title" class="text-2xl font-black uppercase text-white leading-none mb-5 gradient-text"></h2>
                <div id="history-view-fields" class="space-y-3 mb-8"></div>
                <div class="flex gap-3 mt-4">
                    <button onclick="confirmPermanentDelete()" class="flex-1 py-4 rounded-xl bg-gradient-to-br from-red-500/20 to-red-500/10 text-red-500 font-black uppercase text-xs border border-red-500/30 hover:scale-[1.02] transition"><i class="fa-regular fa-trash-can mr-2"></i> Delete</button>
                    <button onclick="closeHistoryViewModal()" class="flex-1 py-4 rounded-xl glass-panel text-white font-black uppercase text-xs border border-white/5 hover:scale-[1.02] transition">back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div id="modal-confirm" class="fixed inset-0 z-[110] hidden items-center justify-center p-6">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-xl"></div>
        <div class="glass-panel w-full max-w-sm rounded-[35px] p-6 relative z-20 text-center animate-pop-up">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 text-primary flex items-center justify-center mx-auto mb-4 border border-primary/20">
                <i id="confirm-icon" class="fa-solid fa-triangle-exclamation text-2xl"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-black uppercase text-white mb-2 gradient-text">Confirm</h3>
            <p id="confirm-message" class="text-[10px] text-gray-500 font-bold uppercase mb-6">Are you sure?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-4 rounded-2xl glass-panel text-[10px] font-black uppercase tracking-widest text-gray-400 hover:scale-[1.02] active:scale-95 transition">Cancel</button>
                <button id="confirm-action-btn" onclick="executeConfirmedAction()" class="flex-1 py-4 rounded-2xl btn-primary text-white text-[10px] font-black uppercase tracking-widest active:scale-95 transition">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        (function(){
            // ========== FIREBASE CONFIG ==========
            // üîÅ REPLACE WITH YOUR OWN FIREBASE PROJECT CONFIG
            const firebaseConfig = {
  apiKey: "AIzaSyBjS3t_CzbX1N8DtrJU9TUb9Tk1T1wPn7w",
  authDomain: "necxcore.firebaseapp.com",
  projectId: "necxcore",
  storageBucket: "necxcore.firebasestorage.app",
  messagingSenderId: "283476423926",
  appId: "1:283476423926:web:6af707e22cfce90a27a8d7"
};

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // ========== GLOBAL STATE ==========
            let notes = [];
            let deletedNotes = [];
            let currentViewId = null;
            let editingId = null;
            let currentFilter = 'all';
            let currentSearch = '';
            let currentUser = null;
            let pendingAction = null; // 'deleteNote', 'logout', 'permanentDelete'
            let historyViewDocId = null; // Firestore doc id for permanent delete
            let currentAuthMode = 'login';

            const categoryDisplay = { social: 'Social', ott: 'OTT', vpn: 'VPN', notes: 'Notes' };
            const categoryIcons = { 
                social: 'fa-brands fa-instagram', 
                ott: 'fa-solid fa-film', 
                vpn: 'fa-solid fa-shield-halved', 
                notes: 'fa-solid fa-note-sticky' 
            };
            const categoryColors = {
                social: '#833ab4',
                ott: '#ff5e62',
                vpn: '#2193b0',
                notes: '#654ea3'
            };

            // ========== NEW RELATIVE TIME FUNCTION ==========
            function getRelativeTime(timestamp) {
                if (!timestamp) return '';
                let date;
                if (timestamp.seconds) {
                    date = new Date(timestamp.seconds * 1000);
                } else {
                    date = new Date(timestamp);
                }
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHour = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHour / 24);

                if (diffSec < 60) return 'just now';
                if (diffMin < 60) return diffMin + 'm ago';
                if (diffHour < 24) return diffHour + 'h ago';
                return diffDay + 'd ago';
            }

            // ========== AUTH STATE OBSERVER ==========
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    
                    // Load user profile from Firestore (optional)
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        document.getElementById('profile-name').innerText = userDoc.data().name || user.displayName || 'User';
                        document.getElementById('profile-email').innerText = user.email;
                        document.getElementById('profile-joined').innerText = userDoc.data().joined || new Date(user.metadata.creationTime).toLocaleDateString();
                    } else {
                        // Fallback
                        document.getElementById('profile-name').innerText = user.displayName || user.email.split('@')[0];
                        document.getElementById('profile-email').innerText = user.email;
                        document.getElementById('profile-joined').innerText = new Date(user.metadata.creationTime).toLocaleDateString();
                    }
                    
                    // Load notes and deleted notes
                    await loadUserNotes();
                    await loadDeletedNotes();
                } else {
                    // User is signed out
                    currentUser = null;
                    document.getElementById('auth-screen').style.display = 'flex';
                    document.getElementById('main-app').style.display = 'none';
                    notes = [];
                    deletedNotes = [];
                    renderNotes();
                }
            });

            // ========== AUTH FUNCTIONS ==========
            window.toggleAuth = function(mode) {
                currentAuthMode = mode;
                document.getElementById('tab-login').classList.toggle('tab-active', mode==='login');
                document.getElementById('tab-login').classList.toggle('tab-inactive', mode!=='login');
                document.getElementById('tab-signup').classList.toggle('tab-active', mode==='signup');
                document.getElementById('tab-signup').classList.toggle('tab-inactive', mode!=='signup');
                const nameGroup = document.getElementById('input-name-group');
                const confirmGroup = document.getElementById('confirm-pass-group');
                if (mode === 'signup') {
                    nameGroup.classList.remove('hidden');
                    confirmGroup.classList.remove('hidden');
                    document.getElementById('auth-btn-text').innerText = 'Create Account';
                } else {
                    nameGroup.classList.add('hidden');
                    confirmGroup.classList.add('hidden');
                    document.getElementById('auth-btn-text').innerText = 'Enter vault';
                }
            };

            window.handleAuth = async function() {
                const email = document.getElementById('auth-email').value.trim();
                const pass = document.getElementById('auth-pass').value;
                const name = document.getElementById('auth-name').value.trim();
                
                if (!email || !pass) { showToast('Fill all fields', 'error'); return; }
                
                // Show loader
                document.getElementById('auth-loader').classList.remove('hidden');
                document.getElementById('auth-btn-text').classList.add('opacity-50');
                
                try {
                    if (currentAuthMode === 'signup') {
                        if (!name) { showToast('Enter your name', 'error'); return; }
                        const confirm = document.getElementById('auth-confirm').value;
                        if (pass !== confirm) { showToast('Passwords do not match', 'error'); return; }
                        
                        // Create user
                        const userCred = await auth.createUserWithEmailAndPassword(email, pass);
                        // Save display name and additional data to Firestore
                        await userCred.user.updateProfile({ displayName: name });
                        await db.collection('users').doc(userCred.user.uid).set({
                            name: name,
                            email: email,
                            joined: new Date().toLocaleDateString()
                        });
                        showToast('Account created!', 'success');
                    } else {
                        // Login
                        await auth.signInWithEmailAndPassword(email, pass);
                        showToast('Welcome back!', 'success');
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    document.getElementById('auth-loader').classList.add('hidden');
                    document.getElementById('auth-btn-text').classList.remove('opacity-50');
                }
            };

            window.confirmLogout = function() {
                closeProfileModal();
                pendingAction = 'logout';
                document.getElementById('confirm-icon').className = 'fa-solid fa-power-off text-2xl';
                document.getElementById('confirm-title').innerText = 'Log out?';
                document.getElementById('confirm-message').innerText = 'Are you sure you want to logout?';
                document.getElementById('modal-confirm').classList.replace('hidden', 'flex');
            };

            window.executeConfirmedAction = async function() {
                if (pendingAction === 'logout') {
                    await auth.signOut();
                    showToast('Logged out', 'success');
                } else if (pendingAction === 'deleteNote' && currentViewId) {
                    // Move note to deletedNotes collection
                    try {
                        const noteRef = db.collection('notes').doc(currentViewId);
                        const noteDoc = await noteRef.get();
                        if (noteDoc.exists) {
                            const noteData = noteDoc.data();
                            // Add to deletedNotes and capture the new doc ID
                            const addedRef = await db.collection('deletedNotes').add({
                                ...noteData,
                                userId: currentUser.uid,
                                deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            // Delete from notes
                            await noteRef.delete();
                            
                            // Update local notes
                            notes = notes.filter(n => n.id !== currentViewId);
                            
                            // Add to local deletedNotes for immediate history update
                            const newDeleted = {
                                id: addedRef.id,
                                ...noteData,
                                userId: currentUser.uid,
                                deletedAt: new Date() // temporary, will be replaced on next load
                            };
                            deletedNotes.unshift(newDeleted);
                            
                            renderNotes();
                            closeViewModal();
                            showToast('Entry moved to history', 'success');
                        }
                    } catch (error) {
                        showToast('Error deleting: ' + error.message, 'error');
                    }
                } else if (pendingAction === 'permanentDelete' && historyViewDocId) {
                    // Permanently delete from deletedNotes
                    try {
                        await db.collection('deletedNotes').doc(historyViewDocId).delete();
                        // Update local deletedNotes
                        deletedNotes = deletedNotes.filter(d => d.id !== historyViewDocId);
                        closeHistoryViewModal();
                        renderHistoryList(); // refresh history modal if open
                        showToast('Permanently deleted', 'success');
                    } catch (error) {
                        showToast('Error: ' + error.message, 'error');
                    }
                }
                closeConfirmModal();
            };

            window.closeConfirmModal = function() {
                document.getElementById('modal-confirm').classList.add('hidden');
                document.getElementById('modal-confirm').classList.remove('flex');
                pendingAction = null;
            };

            window.confirmDeleteNote = function() {
                if (!currentViewId) return;
                pendingAction = 'deleteNote';
                document.getElementById('confirm-icon').className = 'fa-regular fa-trash-can text-2xl';
                document.getElementById('confirm-title').innerText = 'Delete entry?';
                document.getElementById('confirm-message').innerText = 'This will move to history.';
                document.getElementById('modal-confirm').classList.replace('hidden', 'flex');
            };

            // ========== FIRESTORE DATA LOADING ==========
            async function loadUserNotes() {
                if (!currentUser) return;
                try {
                    const snapshot = await db.collection('notes')
                        .where('userId', '==', currentUser.uid)
                        .get();
                    notes = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderNotes();
                } catch (error) {
                    showToast('Error loading notes: ' + error.message, 'error');
                }
            }

            async function loadDeletedNotes() {
                if (!currentUser) return;
                try {
                    // Try with orderBy first (may fail if index missing)
                    const snapshot = await db.collection('deletedNotes')
                        .where('userId', '==', currentUser.uid)
                        .orderBy('deletedAt', 'desc')
                        .get();
                    deletedNotes = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (error) {
                    // If index error, fallback to simple query without orderBy
                    if (error.code === 'failed-precondition' || error.message.includes('index')) {
                        console.warn('Index missing, falling back to unordered query');
                        const snapshot = await db.collection('deletedNotes')
                            .where('userId', '==', currentUser.uid)
                            .get();
                        deletedNotes = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        // Sort manually by deletedAt (if exists) descending
                        deletedNotes.sort((a, b) => {
                            const ta = a.deletedAt?.seconds || 0;
                            const tb = b.deletedAt?.seconds || 0;
                            return tb - ta;
                        });
                        showToast('History loaded (index missing, sorted locally)', 'info');
                    } else {
                        showToast('Error loading history: ' + error.message, 'error');
                        deletedNotes = [];
                    }
                }
            }

            // ========== NOTES CRUD ==========
            window.saveNote = async function() {
                const category = document.getElementById('note-category').value;
                const title = document.getElementById('note-title').value.trim();
                const tag = document.getElementById('note-tag').value.trim();
                const used = document.getElementById('note-used').checked;
                const fbFixed = document.getElementById('note-fbfixed')?.checked || false; // new field
                
                if (!title) { showToast('Title required', 'error'); return; }
                if (!currentUser) { showToast('You must be logged in', 'error'); return; }
                
                // Show loader
                document.getElementById('save-loader').classList.remove('hidden');
                document.getElementById('save-btn-text').classList.add('opacity-50');
                
                try {
                    let noteData = {
                        userId: currentUser.uid,
                        category,
                        title,
                        tag: tag || null,
                        used,
                        fbFixed, // store fbFixed
                        timestamp: editingId ? null : firebase.firestore.FieldValue.serverTimestamp() // let server set on create
                    };
                    
                    if (editingId) {
                        // For update, we keep existing timestamp
                        noteData.timestamp = notes.find(n => n.id === editingId)?.timestamp || new Date();
                    }
                    
                    if (category === 'notes') {
                        const content = document.getElementById('note-content').value.trim();
                        if (!content) { showToast('Content empty', 'error'); return; }
                        noteData.content = content;
                    } else {
                        const fields = {
                            email: document.getElementById('field-email').value.trim() || null,
                            username: document.getElementById('field-username').value.trim() || null,
                            password: document.getElementById('field-password').value.trim() || null,
                            note: document.getElementById('field-note').value.trim() || null
                        };
                        if (!fields.email && !fields.username && !fields.password) {
                            showToast('Fill at least one field', 'error');
                            return;
                        }
                        noteData.fields = fields;
                    }
                    
                    if (editingId) {
                        // Update existing
                        await db.collection('notes').doc(editingId).update(noteData);
                        // Update local array
                        const idx = notes.findIndex(n => n.id === editingId);
                        if (idx !== -1) notes[idx] = { ...notes[idx], ...noteData };
                    } else {
                        // Add new
                        const docRef = await db.collection('notes').add({
                            ...noteData,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // Add to local array with server timestamp (will be refreshed later)
                        // For immediate UI, we can add optimistic note
                        noteData.id = docRef.id;
                        noteData.timestamp = Date.now(); // temporary
                        notes.push(noteData);
                    }
                    
                    // Refresh from server to get correct timestamps
                    await loadUserNotes();
                    
                    closeAddModal();
                    showToast(editingId ? 'Updated' : 'Saved', 'success');
                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                } finally {
                    document.getElementById('save-loader').classList.add('hidden');
                    document.getElementById('save-btn-text').classList.remove('opacity-50');
                }
            };

            // ========== UI RENDERING ==========
            function formatTimestamp(ts) {
                if (!ts) return '';
                if (ts.seconds) return new Date(ts.seconds * 1000).toLocaleDateString();
                return new Date(ts).toLocaleDateString();
            }

            function renderNotes() {
                const grid = document.getElementById('notes-grid');
                const countSpan = document.getElementById('note-count');
                let filtered = notes;
                if (currentFilter !== 'all') {
                    filtered = filtered.filter(n => n.category === currentFilter);
                }
                filtered = filtered.filter(matchesSearch);
                countSpan.innerText = filtered.length;
                
                if (filtered.length === 0) {
                    grid.innerHTML = `<div class="text-center py-20 opacity-60"><i class="fa-regular fa-pen-to-square text-5xl text-white/20 mb-3"></i><p class="text-gray-500 text-sm font-bold uppercase tracking-widest">no entries</p></div>`;
                    return;
                }
                
                const sorted = [...filtered].sort((a,b)=> (b.timestamp?.seconds || b.timestamp || 0) - (a.timestamp?.seconds || a.timestamp || 0));
                let html = '';
                sorted.forEach(note => {
                    const iconClass = categoryIcons[note.category] || 'fa-regular fa-file-lines';
                    const catName = categoryDisplay[note.category] || note.category;
                    let preview = '';
                    if (note.category !== 'notes' && note.fields) {
                        preview = note.fields.email || note.fields.username || 'account';
                    } else {
                        preview = (note.content || '').substring(0,60) + ((note.content||'').length>60?'‚Ä¶':'');
                    }
                    const usedBadge = note.used ? '<span class="text-[7px] font-black text-orange-400 uppercase bg-orange-400/10 px-1.5 py-0.5 rounded-md ml-1">used</span>' : '';
                    const fbBadge = note.fbFixed ? '<span class="text-[7px] font-black text-[#1877F2] uppercase bg-[#1877F2]/10 px-1.5 py-0.5 rounded-md ml-1"><i class="fa-brands fa-facebook-f mr-1"></i>FB</span>' : '';
                    const tagBadge = note.tag ? `<span class="text-[7px] font-black text-white/60 uppercase bg-white/5 px-1.5 py-0.5 rounded-md ml-1">${note.tag}</span>` : '';
                    
                    // MODIFIED: Show relative time + absolute date
                    const relativeTime = getRelativeTime(note.timestamp);
                    const absoluteDate = formatTimestamp(note.timestamp);
                    
                    html += `<div class="note-card rounded-2xl p-4 flex items-center gap-4 group animate-fade-in" onclick="openViewModal('${note.id}')">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-black/40 to-black/60 flex items-center justify-center border border-white/5"><i class="${iconClass} text-2xl" style="color: ${categoryColors[note.category] || '#FF003C'}"></i></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center flex-wrap gap-1 mb-0.5">
                                <span class="text-[7px] font-black text-white/40 uppercase bg-white/5 px-1.5 py-0.5 rounded-md">${catName}</span>
                                ${usedBadge}
                                ${fbBadge}
                                ${tagBadge}
                            </div>
                            <h3 class="font-bold text-[13px] text-white leading-tight truncate">${note.title || 'Untitled'}</h3>
                            <p class="text-[10px] font-mono text-gray-400 mt-1 truncate">${preview}</p>
                            <p class="text-[8px] font-bold text-yellow-400/50 mt-1">${relativeTime} ‚Ä¢ ${absoluteDate}</p>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center border border-white/5 group-hover:bg-primary/20 group-hover:text-primary"><i class="fa-solid fa-chevron-right text-[10px]"></i></div>
                    </div>`;
                });
                grid.innerHTML = html;
            }

            function matchesSearch(note) {
                if (!currentSearch) return true;
                const searchable = [
                    note.title || '',
                    note.tag || '',
                    note.content || '',
                    note.fields?.email || '',
                    note.fields?.username || '',
                    note.fields?.note || ''
                ].join(' ').toLowerCase();
                return searchable.includes(currentSearch);
            }

            window.filterNotes = function(cat, btn) {
                currentFilter = cat;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderNotes();
            };

            window.performSearch = function() {
                currentSearch = document.getElementById('search-input').value.toLowerCase().trim();
                renderNotes();
            };

            window.clearSearch = function() {
                document.getElementById('search-input').value = '';
                currentSearch = '';
                renderNotes();
            };

            // ========== MODAL FUNCTIONS ==========
            window.openAddModal = function(editData = null) {
                const cat = editData?.category || 'social'; // default to social
                document.getElementById('note-category').value = cat;
                const displaySpan = document.getElementById('selected-category-display');
                let iconHtml = '', catName = '';
                if (cat === 'social') {
                    iconHtml = '<i class="fa-brands fa-instagram cat-social"></i>';
                    catName = 'Social';
                } else if (cat === 'ott') {
                    iconHtml = '<i class="fa-solid fa-film cat-ott"></i>';
                    catName = 'OTT';
                } else if (cat === 'vpn') {
                    iconHtml = '<i class="fa-solid fa-shield-halved cat-vpn"></i>';
                    catName = 'VPN';
                } else {
                    iconHtml = '<i class="fa-solid fa-note-sticky cat-notes"></i>';
                    catName = 'Notes';
                }
                displaySpan.innerHTML = iconHtml + '<span>' + catName + '</span>';

                document.getElementById('note-title').value = editData?.title || '';
                document.getElementById('note-tag').value = editData?.tag || '';
                document.getElementById('note-used').checked = editData?.used || false;
                document.getElementById('note-fbfixed').checked = editData?.fbFixed || false;
                document.getElementById('note-content').value = editData?.content || '';
                document.getElementById('field-email').value = editData?.fields?.email || '';
                document.getElementById('field-username').value = editData?.fields?.username || '';
                document.getElementById('field-password').value = editData?.fields?.password || '';
                document.getElementById('field-note').value = editData?.fields?.note || '';
                editingId = editData ? editData.id : null;
                document.getElementById('modal-add-title').innerText = editData ? 'edit record' : 'new record';
                document.getElementById('save-btn-text').innerHTML = editData ? '<i class="fa-regular fa-pen-to-square mr-2"></i> update entry' : '<i class="fa-regular fa-floppy-disk mr-2"></i> save entry';
                toggleFieldsBasedOnCategory(cat);
                toggleFbField(cat); // Show/hide FB toggle based on category
                document.getElementById('modal-add-note').classList.replace('hidden', 'flex');
            };

            window.closeAddModal = function() { 
                document.getElementById('modal-add-note').classList.add('hidden'); 
                editingId = null; 
                document.getElementById('dropdown-options').classList.remove('show');
            };

            function toggleFieldsBasedOnCategory(cat) {
                const simpleGroup = document.getElementById('simple-content-group');
                const structuredGroup = document.getElementById('structured-fields-group');
                if (cat === 'notes') {
                    simpleGroup.classList.remove('hidden');
                    structuredGroup.classList.add('hidden');
                } else {
                    simpleGroup.classList.add('hidden');
                    structuredGroup.classList.remove('hidden');
                }
            }

            function toggleFbField(cat) {
                const fbContainer = document.getElementById('fb-toggle-container');
                if (cat === 'social') {
                    fbContainer.style.display = 'flex';
                } else {
                    fbContainer.style.display = 'none';
                }
            }

            window.toggleDropdown = function() {
                document.getElementById('dropdown-options').classList.toggle('show');
            };

            window.selectCategory = function(value) {
                document.getElementById('note-category').value = value;
                const displaySpan = document.getElementById('selected-category-display');
                let iconHtml = '', catName = '';
                if (value === 'social') {
                    iconHtml = '<i class="fa-brands fa-instagram cat-social"></i>';
                    catName = 'Social';
                } else if (value === 'ott') {
                    iconHtml = '<i class="fa-solid fa-film cat-ott"></i>';
                    catName = 'OTT';
                } else if (value === 'vpn') {
                    iconHtml = '<i class="fa-solid fa-shield-halved cat-vpn"></i>';
                    catName = 'VPN';
                } else {
                    iconHtml = '<i class="fa-solid fa-note-sticky cat-notes"></i>';
                    catName = 'Notes';
                }
                displaySpan.innerHTML = iconHtml + '<span>' + catName + '</span>';
                document.getElementById('dropdown-options').classList.remove('show');
                toggleFieldsBasedOnCategory(value);
                toggleFbField(value); // update FB toggle visibility
            };

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('category-dropdown');
                if (dropdown && !dropdown.contains(event.target)) {
                    document.getElementById('dropdown-options').classList.remove('show');
                }
            });

            window.openViewModal = function(id) {
                const note = notes.find(n => n.id === id);
                if (!note) return;
                currentViewId = id;
                document.getElementById('view-category-badge').innerText = categoryDisplay[note.category] || note.category;
                document.getElementById('view-title').innerText = note.title || '';
                const ts = note.timestamp?.seconds ? new Date(note.timestamp.seconds * 1000) : (note.timestamp ? new Date(note.timestamp) : new Date());
                // MODIFIED: Show relative time + absolute date
                const relativeTime = getRelativeTime(note.timestamp);
                document.getElementById('view-date').innerText = relativeTime + ' ‚Ä¢ ' + ts.toLocaleString();
                
                const usedBadge = document.getElementById('view-used-badge');
                if (note.used) usedBadge.classList.remove('hidden');
                else usedBadge.classList.add('hidden');
                
                const fbBadge = document.getElementById('view-fb-badge');
                if (note.fbFixed) fbBadge.classList.remove('hidden');
                else fbBadge.classList.add('hidden');
                
                const tagBadge = document.getElementById('view-tag-badge');
                if (note.tag) {
                    tagBadge.innerText = note.tag;
                    tagBadge.classList.remove('hidden');
                } else {
                    tagBadge.classList.add('hidden');
                }
                
                const container = document.getElementById('view-fields-container');
                container.innerHTML = '';
                if (note.category !== 'notes' && note.fields) {
                    if (note.fields.email) addFieldRow(container, 'email', note.fields.email, false);
                    if (note.fields.username) addFieldRow(container, 'username', note.fields.username, false);
                    if (note.fields.password) addFieldRow(container, 'password', note.fields.password, true);
                    if (note.fields.note) addFieldRow(container, 'note', note.fields.note, false);
                } else {
                    addFieldRow(container, 'content', note.content || '', false);
                }
                
                document.getElementById('modal-view-note').classList.replace('hidden', 'flex');
            };

            function addFieldRow(container, label, value, isPassword = false) {
                const row = document.createElement('div');
                row.className = 'field-row';
                const fieldId = 'field-'+label+'-'+Math.random();
                if (isPassword) {
                    row.innerHTML = `
                        <span class="field-label">${label}</span>
                        <span class="password-value" id="${fieldId}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                        <button class="eye-btn" onclick="togglePassword('${fieldId}', '${value.replace(/'/g, "\\'")}')"><i class="fa-regular fa-eye"></i></button>
                        <button class="copy-btn" onclick="copyText('${value.replace(/'/g, "\\'")}')"><i class="fa-regular fa-copy"></i></button>
                    `;
                } else {
                    row.innerHTML = `
                        <span class="field-label">${label}</span>
                        <span class="field-value">${escapeHtml(value)}</span>
                        <button class="copy-btn" onclick="copyText('${value.replace(/'/g, "\\'")}')"><i class="fa-regular fa-copy"></i></button>
                    `;
                }
                container.appendChild(row);
            }

            window.togglePassword = function(spanId, realValue) {
                const span = document.getElementById(spanId);
                const btn = span.nextElementSibling;
                if (span.innerText === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                    span.innerText = realValue;
                    btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>';
                } else {
                    span.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    btn.innerHTML = '<i class="fa-regular fa-eye"></i>';
                }
            };

            window.copyText = function(text) {
                navigator.clipboard.writeText(text).then(()=>showToast('Copied!','success'));
            };

            function escapeHtml(unsafe) {
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            window.closeViewModal = function() { document.getElementById('modal-view-note').classList.add('hidden'); currentViewId = null; };

            window.editCurrentNote = function() {
                if (!currentViewId) return;
                const note = notes.find(n => n.id === currentViewId);
                if (note) { closeViewModal(); openAddModal(note); }
            };

            // ========== PROFILE MODAL ==========
            window.openProfileModal = function() {
                document.getElementById('profile-total').innerText = notes.length;
                document.getElementById('modal-profile').classList.replace('hidden', 'flex');
            };
            window.closeProfileModal = function() {
                document.getElementById('modal-profile').classList.add('hidden');
                document.getElementById('modal-profile').classList.remove('flex');
            };

            // ========== HISTORY MODAL ==========
            window.openHistoryModal = async function() {
                closeProfileModal();
                await loadDeletedNotes(); // refresh
                renderHistoryList();
                document.getElementById('modal-history').classList.replace('hidden', 'flex');
            };
            window.closeHistoryModal = function() {
                document.getElementById('modal-history').classList.add('hidden');
                document.getElementById('modal-history').classList.remove('flex');
            };

            function renderHistoryList() {
                const container = document.getElementById('history-list');
                if (deletedNotes.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 opacity-60"><i class="fa-regular fa-clock text-4xl text-white/20 mb-2"></i><p class="text-gray-500 text-xs font-bold uppercase">no deleted entries</p></div>';
                    return;
                }
                let html = '';
                deletedNotes.forEach((item) => {
                    const date = item.deletedAt?.seconds ? new Date(item.deletedAt.seconds * 1000).toLocaleString() : (item.deletedAt ? new Date(item.deletedAt).toLocaleString() : '');
                    html += `
                        <div class="glass-panel p-4 rounded-2xl border border-white/5 flex justify-between items-center">
                            <div class="flex-1 cursor-pointer" onclick="openHistoryViewModal('${item.id}')">
                                <p class="text-xs font-bold text-white uppercase">${item.title || 'Untitled'}</p>
                                <p class="text-[9px] text-gray-400 mt-1">${categoryDisplay[item.category] || item.category} ‚Ä¢ ${date}</p>
                            </div>
                            <button onclick="event.stopPropagation(); confirmPermanentDelete('${item.id}')" class="delete-history-btn"><i class="fa-regular fa-trash-can"></i></button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }

            window.openHistoryViewModal = function(docId) {
                const item = deletedNotes.find(d => d.id === docId);
                if (!item) return;
                historyViewDocId = docId;
                document.getElementById('history-view-category').innerText = categoryDisplay[item.category] || item.category;
                document.getElementById('history-view-title').innerText = item.title || '';
                const deletedDate = item.deletedAt?.seconds ? new Date(item.deletedAt.seconds * 1000).toLocaleString() : (item.deletedAt ? new Date(item.deletedAt).toLocaleString() : '');
                document.getElementById('history-view-deleted').innerText = deletedDate;
                
                const usedBadge = document.getElementById('history-view-used');
                if (item.used) usedBadge.classList.remove('hidden');
                else usedBadge.classList.add('hidden');
                
                const fbBadge = document.getElementById('history-view-fb');
                if (item.fbFixed) fbBadge.classList.remove('hidden');
                else fbBadge.classList.add('hidden');
                
                const tagBadge = document.getElementById('history-view-tag');
                if (item.tag) {
                    tagBadge.innerText = item.tag;
                    tagBadge.classList.remove('hidden');
                } else {
                    tagBadge.classList.add('hidden');
                }
                
                const container = document.getElementById('history-view-fields');
                container.innerHTML = '';
                if (item.category !== 'notes' && item.fields) {
                    if (item.fields.email) addFieldRowReadOnly(container, 'email', item.fields.email);
                    if (item.fields.username) addFieldRowReadOnly(container, 'username', item.fields.username);
                    if (item.fields.password) addFieldRowReadOnly(container, 'password', item.fields.password);
                    if (item.fields.note) addFieldRowReadOnly(container, 'note', item.fields.note);
                } else {
                    addFieldRowReadOnly(container, 'content', item.content || '');
                }
                
                document.getElementById('modal-history-view').classList.replace('hidden', 'flex');
            };

            function addFieldRowReadOnly(container, label, value) {
                const row = document.createElement('div');
                row.className = 'field-row';
                row.innerHTML = `
                    <span class="field-label">${label}</span>
                    <span class="field-value">${escapeHtml(value)}</span>
                    <button class="copy-btn" onclick="copyText('${value.replace(/'/g, "\\'")}')"><i class="fa-regular fa-copy"></i></button>
                `;
                container.appendChild(row);
            }

            window.closeHistoryViewModal = function() {
                document.getElementById('modal-history-view').classList.add('hidden');
                document.getElementById('modal-history-view').classList.remove('flex');
                historyViewDocId = null;
            };

            window.confirmPermanentDelete = function(docId) {
                historyViewDocId = docId;
                pendingAction = 'permanentDelete';
                document.getElementById('confirm-icon').className = 'fa-regular fa-trash-can text-2xl';
                document.getElementById('confirm-title').innerText = 'Permanently delete?';
                document.getElementById('confirm-message').innerText = 'This cannot be undone.';
                document.getElementById('modal-confirm').classList.replace('hidden', 'flex');
            };

            // ========== TOAST ==========
            window.showToast = function(msg, type='info') {
                const toast = document.createElement('div');
                let bg = type==='error' ? 'from-red-500/10 to-red-500/5 border-red-500/20' : 'from-primary/10 to-primary/5 border-primary/20';
                let icon = type==='error' ? 'fa-exclamation-circle' : 'fa-check-circle';
                toast.className = `px-6 py-3 rounded-full backdrop-blur-xl border shadow-2xl animate-slide-down mx-auto w-max bg-gradient-to-br ${bg} text-white`;
                toast.innerHTML = `<i class="fa-solid ${icon} mr-2"></i><span class="text-xs font-bold uppercase">${msg}</span>`;
                document.getElementById('toast-area').appendChild(toast);
                setTimeout(()=>toast.remove(), 2800);
            };

            window.closeAllModals = function() { 
                closeAddModal(); 
                closeViewModal(); 
                closeProfileModal(); 
                closeConfirmModal(); 
                closeHistoryModal(); 
                closeHistoryViewModal(); 
            };
        })();
    </script>
</body>
</html>
